name: Security Audit

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * 1"

jobs:
  cargo-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Audit Rust dependencies
        shell: bash
        run: |
          set -euo pipefail
          for lock_file in Cargo.lock crates/pf_dsl/Cargo.lock crates/pf_lsp/Cargo.lock; do
            echo "Auditing ${lock_file}"
            cargo audit --file "${lock_file}"
          done

  npm-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: editors/code
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: editors/code/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Audit npm dependencies
        run: npm audit --audit-level=high
