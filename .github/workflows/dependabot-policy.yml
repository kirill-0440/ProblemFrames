name: Dependabot Policy

on:
  pull_request_target:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: dependabot-policy-${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  policy:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce Dependabot policy
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull request payload found.");
              return;
            }

            const actor = pr.user?.login || "";
            if (actor !== "dependabot[bot]") {
              core.info("Not a Dependabot PR; policy check is a no-op.");
              return;
            }

            const labels = (pr.labels || []).map((label) => label.name);
            const branch = pr.head?.ref || "";
            const problems = [];

            if (pr.base?.ref !== "main") {
              problems.push("Dependabot PRs must target main.");
            }
            if (!branch.startsWith("dependabot/")) {
              problems.push("Dependabot PR branch name must start with dependabot/.");
            }
            if (!labels.includes("dependencies")) {
              problems.push("Dependabot PR must include the dependencies label.");
            }

            if (problems.length > 0) {
              core.setFailed(problems.join(" "));
              return;
            }

            core.info("Dependabot policy checks passed.");
